<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Diary c·ªßa Ch√≠p</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#ffe6f0;
  font-family:'Patrick Hand', cursive;
}

.app{
  width:100vw;
  height:100vh;
  position:relative;
  overflow:hidden;
}

/* HEADER */
.header{
  padding:20px 32px;
  font-size:36px;
  color:#ff4d94;
}

/* GRID */
.grid{
  padding:0 32px 32px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:24px;
}

.card{
  height:180px;
  background:white;
  border-radius:20px;
  box-shadow:0 10px 25px rgba(255,105,180,.25);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  transition:.25s;
}
.card:hover{transform:translateY(-6px)}

.card.add{
  font-size:48px;
  color:#ff4d94;
}

/* DETAIL */
.detail{
  position:absolute;
  inset:0;
  background:#fff;
  padding:32px;
  opacity:0;
  pointer-events:none;
  transform:scale(.95);
  transition:.3s;
}
.detail.active{
  opacity:1;
  pointer-events:auto;
  transform:scale(1);
}

.back{
  background:none;
  border:none;
  font-size:22px;
  color:#ff4d94;
  cursor:pointer;
}

/* FORM */
input,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:2px solid #ffd1e8;
  font-family:inherit;
  font-size:18px;
}

textarea{min-height:100px;resize:none}

/* IMAGES */
.images{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:12px;
}
.images img{
  width:100px;
  height:100px;
  object-fit:cover;
  border-radius:14px;
  box-shadow:0 5px 15px rgba(0,0,0,.15);
}

/* UPLOAD */
.upload-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:999px;
  background:#ff4d94;
  color:white;
  font-size:18px;
  cursor:pointer;
  margin-top:8px;
}
.upload-btn:hover{background:#ff2f84}

input[type="file"]{display:none}
</style>
</head>

<body>
<div class="app">

  <div class="header">üìñ Diary c·ªßa Ch√≠p</div>

  <div class="grid" id="grid"></div>

  <div class="detail" id="detail">
    <button class="back">‚Üê Back</button>

    <h2>Ti√™u ƒë·ªÅ</h2>
    <input id="titleInput">

    <h2>Note</h2>
    <textarea id="noteInput"></textarea>

    <h2>·∫¢nh</h2>
    <label class="upload-btn">
      üì∑ Th√™m ·∫£nh
      <input type="file" id="imageInput" accept="image/*" multiple>
    </label>

    <div class="images" id="images"></div>
  </div>

</div>

<script type="module">
/* ===== FIREBASE IMPORT ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  getDoc, updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDGWdRCOq0bhO-NfJM-gTnd_M-WTas3Ym8",
  authDomain: "lovechip-14-2.firebaseapp.com",
  projectId: "lovechip-14-2",
  storageBucket: "lovechip-14-2.appspot.com",
  messagingSenderId: "78998414674",
  appId: "1:78998414674:web:a2ad10d0f165e1341bc68b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ===== UI ===== */
const grid = document.getElementById("grid");
const detail = document.getElementById("detail");
const titleInput = document.getElementById("titleInput");
const noteInput = document.getElementById("noteInput");
const imageInput = document.getElementById("imageInput");
const imagesBox = document.getElementById("images");
const backBtn = document.querySelector(".back");

let currentId = null;

/* ===== LOAD GRID ===== */
async function renderGrid() {
  console.log("renderGrid called");
  grid.innerHTML = "";

  const add = document.createElement("div");
  add.className = "card add";
  add.innerText = "+";
  add.onclick = createCard;
  grid.appendChild(add);
}

/* ===== IMAGES ===== */
function renderImages(list){
  imagesBox.innerHTML="";
  list.forEach(src=>{
    const img=document.createElement("img");
    img.src=src;
    imagesBox.appendChild(img);
  });
}

/* ===== UPDATE ===== */
titleInput.oninput=()=>updateDoc(doc(db,"diary",currentId),{title:titleInput.value}).then(renderGrid);
noteInput.oninput=()=>updateDoc(doc(db,"diary",currentId),{note:noteInput.value});

/* ===== UPLOAD ===== */
imageInput.onchange=async()=>{
  const files=[...imageInput.files];
  const urls=[];

  for(const f of files){
    const r=ref(storage,`images/${currentId}/${Date.now()}_${f.name}`);
    await uploadBytes(r,f);
    urls.push(await getDownloadURL(r));
  }

  const snap=await getDoc(doc(db,"diary",currentId));
  const old=snap.data().images||[];

  await updateDoc(doc(db,"diary",currentId),{images:[...old,...urls]});
  renderImages([...old,...urls]);
  imageInput.value="";
};

backBtn.onclick=()=>{
  detail.classList.remove("active");
};

renderGrid();
</script>
</body>
</html>
