<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Diary c·ªßa Ch√≠p</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#ffe6f0;
  font-family:'Patrick Hand', cursive;
}

.app{
  width:100vw;
  height:100vh;
  position:relative;
  overflow:hidden;
}

/* ===== HEADER ===== */
.header{
  padding:20px 32px;
  font-size:36px;
  color:#ff4d94;
}

/* ===== GRID ===== */
.grid{
  padding:0 32px 32px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:24px;
  transition:.4s;
}

.card{
  height:180px;
  background:white;
  border-radius:20px;
  box-shadow:0 10px 25px rgba(255,105,180,.25);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  transition:.25s;
}
.card:hover{transform:translateY(-6px)}

.card.add{
  font-size:40px;
  color:#ff4d94;
}

/* ===== DETAIL ===== */
.detail{
  position:absolute;
  inset:0;
  background:#fff;
  padding:32px;
  opacity:0;
  transform:scale(.92);
  pointer-events:none;
  transition:.4s;
}
.detail.active{
  opacity:1;
  transform:scale(1);
  pointer-events:auto;
}

.back{
  background:none;
  border:none;
  font-size:22px;
  color:#ff4d94;
  cursor:pointer;
}

/* ===== FORM ===== */
input,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:2px solid #ffd1e8;
  font-family:inherit;
  font-size:18px;
}

textarea{min-height:100px;resize:none}

/* ===== IMAGE ===== */
.images{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:12px;
}

.images img{
  width:100px;
  height:100px;
  object-fit:cover;
  border-radius:14px;
  box-shadow:0 5px 15px rgba(0,0,0,.15);
}

/* ===== CUTE BUTTON ===== */
.upload-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:999px;
  background:#ff4d94;
  color:white;
  font-size:18px;
  cursor:pointer;
  margin-top:8px;
  box-shadow:0 6px 15px rgba(255,77,148,.35);
  transition:.2s;
}
.upload-btn:hover{
  transform:scale(1.05);
  background:#ff2f84;
}

.upload-btn span{
  font-size:22px;
}

input[type="file"]{
  display:none;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">üìñ Diary c·ªßa Ch√≠p</div>

  <div class="grid" id="grid"></div>

  <div class="detail" id="detail">
    <button class="back">‚Üê Back</button>

    <h2>Ti√™u ƒë·ªÅ</h2>
    <input id="titleInput">

    <h2>Note</h2>
    <textarea id="noteInput"></textarea>

    <h2>·∫¢nh</h2>

    <label class="upload-btn">
      <span>üì∑</span> Th√™m ·∫£nh
      <input type="file" id="imageInput" accept="image/*" multiple>
    </label>

    <div class="images" id="images"></div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDGWdRCOq0bhO-NfJM-gTnd_M-WTas3Ym8",
    authDomain: "lovechip-14-2.firebaseapp.com",
    projectId: "lovechip-14-2",
    storageBucket: "lovechip-14-2.appspot.com",
    messagingSenderId: "78998414674",
    appId: "1:78998414674:web:a2ad10d0f165e1341bc68b",
    measurementId: "G-64YWE2ZQ14"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  /* ====== DIARY LOGIC ====== */

  const grid = document.getElementById("grid");
  const detail = document.getElementById("detail");
  const titleInput = document.getElementById("titleInput");
  const noteInput = document.getElementById("noteInput");
  const imageInput = document.getElementById("imageInput");
  const imagesBox = document.getElementById("images");
  const backBtn = document.querySelector(".back");

  let currentId = null;

  // LOAD CARDS
  async function renderGrid() {
    grid.innerHTML = "";

    const snap = await getDocs(collection(db, "diary"));

    snap.forEach(docSnap => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerText = docSnap.data().title || "No title";
      card.onclick = () => openDetail(docSnap.id);
      grid.appendChild(card);
    });

    const add = document.createElement("div");
    add.className = "card add";
    add.innerText = "+";
    add.onclick = createCard;
    grid.appendChild(add);
  }

  // CREATE CARD
  async function createCard() {
    await addDoc(collection(db, "diary"), {
      title: "New Note",
      note: "",
      images: [],
      createdAt: serverTimestamp()
    });
    renderGrid();
  }

  // OPEN DETAIL
  async function openDetail(id) {
    currentId = id;
    const snap = await getDoc(doc(db, "diary", id));
    const data = snap.data();

    titleInput.value = data.title;
    noteInput.value = data.note;
    renderImages(data.images || []);

    grid.style.opacity = 0;
    detail.classList.add("active");
  }

  function renderImages(list) {
    imagesBox.innerHTML = "";
    list.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      imagesBox.appendChild(img);
    });
  }

  // UPDATE TITLE
  titleInput.oninput = async () => {
    await updateDoc(doc(db, "diary", currentId), {
      title: titleInput.value
    });
    renderGrid();
  };

  // UPDATE NOTE
  noteInput.oninput = async () => {
    await updateDoc(doc(db, "diary", currentId), {
      note: noteInput.value
    });
  };

  // UPLOAD IMAGE
  imageInput.onchange = async () => {
    const files = Array.from(imageInput.files);
    const urls = [];

    for (let file of files) {
      const imgRef = ref(storage, `images/${currentId}/${Date.now()}_${file.name}`);
      await uploadBytes(imgRef, file);
      const url = await getDownloadURL(imgRef);
      urls.push(url);
    }

    const snap = await getDoc(doc(db, "diary", currentId));
    const oldImages = snap.data().images || [];

    await updateDoc(doc(db, "diary", currentId), {
      images: [...oldImages, ...urls]
    });

    renderImages([...oldImages, ...urls]);
    imageInput.value = "";
  };

  backBtn.onclick = () => {
    detail.classList.remove("active");
    grid.style.opacity = 1;
  };

  renderGrid();
</script>

</body>
</html>
